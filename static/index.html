<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>경제 대시보드 </title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; }
    input { padding: 6px 8px; }
    button { padding: 7px 10px; cursor: pointer; }
    .box { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 14px 0; }
    table { border-collapse: collapse; width: 100%; min-width: 680px; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; text-align: left; font-size: 14px; }
    .muted { color: #666; font-size: 13px; }
    .scroll { overflow-x: auto; }
    a { text-decoration: underline; }
    .err { color: #b00020; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>경제 대시보드 </h1>
  <div class="muted">환율 정보 및 경제 관련 이슈 </div>

  <div class="box">
    <h2 style="margin:0 0 10px; font-size:18px;">환율 (최근 N일)</h2>
    <div class="row">
      <label>days:
        <input id="days" type="number" min="2" max="60" value="14" />
      </label>
      <button onclick="loadExchange()">환율 불러오기</button>
      <span id="exchangeRange" class="muted"></span>
    </div>
    <div id="exchangeError" class="err"></div>
    <div class="scroll">
      <table id="exchangeTable" style="display:none;">
        <thead>
          <tr>
            <th>날짜</th>
            <th>USD→KRW</th>
            <th>EUR→KRW</th>
            <th>JPY→KRW</th>
            <th>100JPY→KRW</th>
          </tr>
        </thead>
        <tbody id="exchangeBody"></tbody>
      </table>
    </div>
  </div>

  <div class="box">
    <h2 style="margin:0 0 10px; font-size:18px;">경제 뉴스</h2>
    <div class="row">
      <label>timespan:
        <input id="timespan" value="1d" />
      </label>
      <label>max:
        <input id="maxrecords" type="number" min="1" max="100" value="20" />
      </label>
      <button onclick="loadNews()">뉴스 불러오기</button>
      <span id="newsMeta" class="muted"></span>
    </div>
    <div id="newsError" class="err"></div>
    <ol id="newsList"></ol>
  </div>

<script>
  async function safeRead(res) {
    const txt = await res.text();
    try {
      return { ok: res.ok, json: JSON.parse(txt), raw: txt, status: res.status };
    } catch {
      return { ok: res.ok, json: null, raw: txt, status: res.status };
    }
  }

    function num(x, digits) {
    if (x === null || x === undefined) return "-";
    return Number(x).toFixed(digits);
  }

  async function loadExchange() {
    const days = document.getElementById("days").value || 14;
    const errEl = document.getElementById("exchangeError");
    const rangeEl = document.getElementById("exchangeRange");
    const tableEl = document.getElementById("exchangeTable");
    const bodyEl = document.getElementById("exchangeBody");

    // DOM 존재 검증
    if (!errEl || !rangeEl || !tableEl || !bodyEl) {
      console.error("Missing DOM elements:", { errEl, rangeEl, tableEl, bodyEl });
      return;
    }

    errEl.textContent = "";
    rangeEl.textContent = "불러오는 중...";
    bodyEl.innerHTML = "";
    tableEl.style.display = "";          // ✅ 일단 테이블을 보이게

    try {
      // (선택) refresh 먼저 하고 싶으면 주석 해제
      // await fetch(`/exchange/refresh?days=${encodeURIComponent(days)}`, { method: "POST" });

      const res = await fetch(`/exchange?days=${encodeURIComponent(days)}`);
      const txt = await res.text();

      // JSON 파싱 안전 처리
      let data;
      try { data = JSON.parse(txt); }
      catch { throw new Error("Response is not JSON:\n" + txt); }

      if (!res.ok) throw new Error(JSON.stringify(data, null, 2));

      const rows = data.rows || [];
      rangeEl.textContent = `기간: ${data.range?.start ?? "?"} ~ ${data.range?.end ?? "?"}`;

      if (rows.length === 0) {
        errEl.textContent = "표시할 환율 데이터가 없습니다. (먼저 /exchange/refresh 를 호출해야 할 수 있어요)";
        return;
      }

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.date ?? "-"}</td>
          <td>${num(r.usd_krw, 2)}</td>
          <td>${num(r.eur_krw, 2)}</td>
          <td>${num(r.jpy_krw, 4)}</td>
          <td>${num(r.jpy100_krw, 2)}</td>
        `;
        bodyEl.appendChild(tr);
      }

    } catch (e) {
      rangeEl.textContent = "";
      errEl.textContent = String(e);
      console.error(e);
    }
  }


  async function loadNews() {
    const timespan = document.getElementById("timespan").value || "1d";
    const maxrecords = document.getElementById("maxrecords").value || 20;

    const err = document.getElementById("newsError");
    const meta = document.getElementById("newsMeta");
    const list = document.getElementById("newsList");

    err.textContent = "";
    meta.textContent = "";
    list.innerHTML = "";

    try {
      // 1) refresh (저장) - 이미 저장돼 있어도 OK
      const r1 = await fetch(`/news/refresh?timespan=${encodeURIComponent(timespan)}&maxrecords=${encodeURIComponent(maxrecords)}`, {
        method: "POST",
      });
      const a1 = await safeRead(r1);
      if (!a1.ok) throw new Error(`refresh failed (${a1.status})\n` + (a1.json ? JSON.stringify(a1.json, null, 2) : a1.raw));

      // 2) get (조회)
      const r2 = await fetch(`/news?limit=${encodeURIComponent(maxrecords)}`);
      const a2 = await safeRead(r2);
      if (!a2.ok) throw new Error(`get failed (${a2.status})\n` + (a2.json ? JSON.stringify(a2.json, null, 2) : a2.raw));

      const data = a2.json || {};
      const articles = data.articles || [];

      meta.textContent = `timespan=${timespan} · ${articles.length}건`;

      if (articles.length === 0) {
        const li = document.createElement("li");
        li.textContent = "DB에 저장된 뉴스가 없습니다.";
        list.appendChild(li);
        return;
      }

      for (const a of articles) {
        const li = document.createElement("li");
        li.style.marginBottom = "10px";
        li.innerHTML = `
          <a href="${a.url}" target="_blank" rel="noreferrer">${a.title || "(no title)"}</a>
          <div class="muted">${a.domain ? " · " + a.domain : ""}${a.seendate ? " · " + a.seendate : ""}</div>
        `;
        list.appendChild(li);
      }
    } catch (e) {
      err.textContent = String(e);
    }
  }
</script>

</body>
</html>

